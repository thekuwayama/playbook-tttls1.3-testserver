- name: Install certbot
  yum:
    name: certbot

- name: Make directory
  file:
    path: /etc/letsencrypt/live/thekuwayama.net
    state: directory
    recurse: true
    owner: root
    group: root
    mode: 0644

- name: Check existence of a certificate
  stat:
    path: /etc/letsencrypt/live/thekuwayama.net/fullchain.pem
  register: fullchain

- name: Check existence of a private-key
  stat:
    path: /etc/letsencrypt/live/thekuwayama.net/privkey.pem
  register: privkey

- name: Issue a certificate with ACME
  shell: bash -lc "certbot certonly --standalone --domain thekuwayama.net --email thekuwayama@gmail.com --agree-tos --no-eff-email"
  when: fullchain.stat.exists == False or privkey.stat.exists == False

- name: Renew a certificate
  shell: bash -lc "certbot renew"
  when: not (fullchain.stat.exists == False or privkey.stat.exists == False)

- name: Set crontab of certbot
  cron:
    name: 'certbot renew'
    minute: '0'
    hour: '2'
